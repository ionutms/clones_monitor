name: Monitor Repository Clones

on:
  schedule:
    # Run every hour
    - cron: '0 * * * *'
  workflow_dispatch:  # Allow manual triggering

jobs:
  monitor-clones:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout clones_monitor repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for all branches and tags
      
    - name: Setup GitHub CLI
      uses: sersoft-gmbh/setup-gh-cli-action@v2.0.1
      
    - name: Fetch clone statistics
      env:
        GH_TOKEN: ${{ secrets.CLONE_MONITOR_TOKEN }}
      run: |
        # Fetch current timestamp in human-readable format
        timestamp=$(date -u +"%Y/%m/%d/%H/%M/%S")
        
        # Fetch clones for the public repository
        gh api repos/ionutms/KiCAD_Symbols_Generator/traffic/clones \
          > clones_data.json
        
        # Ensure CSV exists with header if it doesn't
        if [ ! -f clones_history.csv ]; then
          echo "collection_timestamp,clone_timestamp,total_clones,unique_clones" > clones_history.csv
        fi
        
        # Parse the JSON and append to CSV with consistent timestamp format
        jq -r --arg timestamp "$timestamp" '
          .clones | 
          map([
            $timestamp, 
            (.timestamp | split("T")[0] | split("-") | join("/") + "/" + (.timestamp | split("T")[1] | split(":")[0,1] | join("/") + "/00"), 
            .count, 
            .uniques
          ] | @csv)[] 
        ' clones_data.json >> clones_history.csv
    
    - name: Commit and push clone data
      run: |
        git config user.name 'GitHub Actions Bot'
        git config user.email '<>'
        
        # Pull latest changes first
        git pull origin main --rebase
        
        # Stage, commit, and push changes
        git add clones_history.csv
        git commit -m "Update clone statistics" || exit 0
        git push origin main