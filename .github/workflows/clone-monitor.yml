name: Monitor Repository Clones and Visitors

on:
  schedule:
    # Run every 6 hours (at 00:00, 06:00, 12:00, and 18:00 UTC)
    - cron: '0 */6 * * *'
  workflow_dispatch:  # Allow manual triggering
  push:
    branches:
      - main  # Trigger on pushes to the main branch

jobs:
  monitor-traffic:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout monitoring repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for all branches and tags
    
    - name: Checkout KiCAD_Symbols_Generator repository
      uses: actions/checkout@v4
      with:
        repository: ionutms/KiCAD_Symbols_Generator
        path: kicat-repo
    
    - name: Setup GitHub CLI
      uses: sersoft-gmbh/setup-gh-cli-action@v2.0.1
      
    - name: Fetch clone and visitor statistics
      env:
        GH_TOKEN: ${{ secrets.CLONE_MONITOR_TOKEN }}
      run: |
        # Ensure clone CSV exists with header if it doesn't
        if [ ! -f clones_history.csv ]; then
          echo "clone_timestamp,total_clones,unique_clones" > clones_history.csv
        fi
        
        # Ensure visitors CSV exists with header if it doesn't
        if [ ! -f visitors_history.csv ]; then
          echo "visitor_timestamp,total_visitors,unique_visitors" > visitors_history.csv
        fi
        
        # Repository to monitor
        repo="ionutms/KiCAD_Symbols_Generator"
        
        # Fetch clones for the main branch and append to clone CSV
        gh api "repos/$repo/traffic/clones?per_page=100&ref=main" | \
        jq -r '
          .clones |
          map([
            (.timestamp | sub("T.*";"") | sub("Z$";"")) ,
            .count,
            .uniques
          ] | @csv)[]
        ' >> clones_history.csv
        
        # Fetch visitors for the main branch and append to visitors CSV
        gh api "repos/$repo/traffic/views?per_page=100&ref=main" | \
        jq -r '
          .views |
          map([
            (.timestamp | sub("T.*";"") | sub("Z$";"")) ,
            .count,
            .uniques
          ] | @csv)[]
        ' >> visitors_history.csv
    
    - name: Remove duplicate rows from CSVs
      run: |
        # Process clone CSV
        echo "clone_timestamp,total_clones,unique_clones" > clones_history_fixed.csv
        awk '
          BEGIN { FS=OFS="," }
          NR==1 && $1 == "clone_timestamp" { next }
          { data[$1] = $0 }
          END {
            for (timestamp in data) {
              print data[timestamp]
            }
          }
        ' clones_history.csv | sort -t, -k1 >> clones_history_fixed.csv
        mv clones_history_fixed.csv clones_history.csv
        
        # Process visitors CSV
        echo "visitor_timestamp,total_visitors,unique_visitors" > visitors_history_fixed.csv
        awk '
          BEGIN { FS=OFS="," }
          NR==1 && $1 == "visitor_timestamp" { next }
          { data[$1] = $0 }
          END {
            for (timestamp in data) {
              print data[timestamp]
            }
          }
        ' visitors_history.csv | sort -t, -k1 >> visitors_history_fixed.csv
        mv visitors_history_fixed.csv visitors_history.csv
    
    - name: Commit and push traffic data to monitoring repository
      env:
        GH_TOKEN: ${{ secrets.CLONE_MONITOR_TOKEN }}
      run: |
        git config user.name 'GitHub Actions Bot'
        git config user.email '<>'
        
        # Copy CSVs to KiCAD repo
        cp clones_history.csv kicat-repo/clones_history.csv
        cp visitors_history.csv kicat-repo/visitors_history.csv
        
        # Commit to monitoring repository
        git add clones_history.csv visitors_history.csv
        
        if [[ -n $(git status -s) ]]; then
          git commit -m "Update clone and visitor statistics for $(date -u +"%Y-%m-%d %H:%M:%S")"
          git pull --rebase origin main
          git push origin main
        else
          echo "No new traffic data to update in monitoring repository"
        fi
    
    - name: Commit and push traffic data to KiCAD_Symbols_Generator repository
      env:
        GH_TOKEN: ${{ secrets.CLONE_MONITOR_TOKEN }}
      run: |
        cd kicat-repo
        
        git config user.name 'GitHub Actions Bot'
        git config user.email '<>'
        
        # Stage CSV files
        git add clones_history.csv visitors_history.csv
        
        if [[ -n $(git status -s) ]]; then
          git commit -m "Update clone and visitor statistics for $(date -u +"%Y-%m-%d %H:%M:%S")"
          git pull --rebase origin main
          git push origin main
        else
          echo "No new traffic data to update in KiCAD repository"
        fi